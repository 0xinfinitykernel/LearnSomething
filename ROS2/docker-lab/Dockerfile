FROM osrf/ros:humble-desktop-full

LABEL maintainer="0x@infinitykernel.com"

# ========= æ„å»ºæ—¶å‚æ•° =========
ARG USER
ARG USER_ID
ARG GROUP_ID
ARG GIT_USER
ARG GIT_PASS

# å®‰è£… sudoã€å¼€å‘å·¥å…·
RUN apt update && \
    apt install -y sudo git python3-colcon-common-extensions curl python3 && \
    rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå’Œå®¿ä¸»æœºä¸€è‡´çš„ç”¨æˆ·ï¼Œé¿å…æŒ‚è½½ç›®å½• root æƒé™é—®é¢˜
RUN groupadd -g ${GROUP_ID} ${USER} && \
    useradd -m -u ${USER_ID} -g ${GROUP_ID} ${USER} && \
    echo "${USER} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# åˆ‡æ¢ç”¨æˆ·
USER ${USER}
WORKDIR /home/${USER}

# é»˜è®¤å·¥ä½œåŒºç»“æ„
ENV ROS_WORKSPACE=/home/${USER}/ws
RUN mkdir -p $ROS_WORKSPACE/src
WORKDIR $ROS_WORKSPACE/src

# ======= å¤šé¡¹ç›®æ”¯æŒ =======
# æ·»åŠ é¡¹ç›®åˆ—è¡¨æ–‡ä»¶ï¼ˆä½ æå‰å‡†å¤‡å¥½ï¼‰
COPY projects.txt /tmp/projects.txt

# å…‹éš†æ‰€æœ‰é¡¹ç›®ï¼ˆé¡¹ç›®åœ°å€å†™åœ¨ projects.txtï¼Œè‡ªåŠ¨æ³¨å…¥ç”¨æˆ·åå¯†ç ï¼‰
RUN set -e; \
    ENCODED_PASS=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${GIT_PASS}'))"); \
    while IFS= read -r raw_url; do \
      proto=$(echo $raw_url | cut -d/ -f1); \
      host_and_path=$(echo $raw_url | cut -d/ -f3-); \
      full_url="${proto}//${GIT_USER}:${ENCODED_PASS}@${host_and_path}"; \
      echo "â¬ Cloning $full_url ..."; \
      git clone "$full_url"; \
    done < /tmp/projects.txt

# å®‰è£…æ¯ä¸ªé¡¹ç›®çš„ install.shï¼ˆå¦‚æœæœ‰ï¼‰
RUN set -e; \
    for d in */ ; do \
      if [ -f "$d/install.sh" ]; then \
        echo "ğŸ”§ Installing $d/install.sh ..."; \
        cd "$d" && chmod +x install.sh && sudo ./install.sh && cd ..; \
      fi \
    done

# è‡ªåŠ¨ä¿®å¤ç¼ºå¤±å®å®šä¹‰
#RUN find . \( -name "*.cpp" -o -name "*.h" \) -type f | xargs sed -i 's/LX_INT_2D_UNDISTORT_SCALE/LX_INT_3D_UNDISTORT_SCALE/g'
# è‡ªåŠ¨ä¿®å¤ç¼ºå¤±å®å®šä¹‰ï¼ˆä»…å½“ SDK ä¸­æ²¡æœ‰å®šä¹‰æ—¶æ‰æ›¿æ¢ï¼‰
RUN if grep -qr "LX_INT_2D_UNDISTORT_SCALE" /opt/Lanxin-MRDVS/include; then \
      echo "âœ… SDK defines LX_INT_2D_UNDISTORT_SCALE, no need to patch"; \
    else \
      echo "âš ï¸  LX_INT_2D_UNDISTORT_SCALE not found, patching to LX_INT_3D_UNDISTORT_SCALE"; \
      find . \( -name "*.cpp" -o -name "*.h" \) -type f -print0 \
        | xargs -0 --no-run-if-empty sed -i 's/LX_INT_2D_UNDISTORT_SCALE/LX_INT_3D_UNDISTORT_SCALE/g'; \
    fi

# ç¼–è¯‘æ‰€æœ‰é¡¹ç›®
WORKDIR $ROS_WORKSPACE
RUN bash -c "source /opt/ros/humble/setup.bash && colcon build"

# é»˜è®¤å…¥å£ç”± docker-compose æ§åˆ¶
